package com.filebox.common.model;

import com.filebox.common.kit.ImageKit;
import com.filebox.common.kit.RetKit;
import com.filebox.common.model.base.BaseRepairApplication;
import com.jfinal.kit.PathKit;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.upload.UploadFile;

/**
 * Generated by JFinal.
 */
@SuppressWarnings("serial")
public class RepairApplication extends BaseRepairApplication<RepairApplication> {
	
	public static final int OPENED_BROKEN = 1;
	public static final int CLOSED_BROKEN = 2;
	public static final int BOX_POLLUTED = 3;
	public static final int BOX_BROKEN = 4;
	public static final int OTHER_PROBLEM = 5;
	
	public static final int maxPictureSize = 1024 * 1024;
	public static final String  uploadDir = "/upload/repair/";
	
	public static final int PENDING_STATUS = 0;
	public static final int REAPIRING_STATUS = 1;
	public static final int REPAIRED_STATUS = 2;
	
	
	public static RetKit savePhoto(UploadFile uFile) {
		if (uFile == null) {
			return RetKit.fail("msg", "上传文件UploadFile对象不能为null");
		}
		try {
			if (ImageKit.notImageExtName(uFile.getFileName())) {
				return RetKit.fail("msg", "文件类型不正确，只支持图片类型：gif、jpg、jpeg、png、bmp");
			}
			String avatarUrl = uploadDir + System.currentTimeMillis() + "." + ImageKit.getExtName(uFile.getFileName());
			String saveFile = PathKit.getWebRootPath() + avatarUrl;
			ImageKit.zoom(500, uFile.getFile(), saveFile);
			return RetKit.ok("photoUrl", avatarUrl);
		}
		catch (Exception e) {
			return RetKit.fail("msg", e.getMessage());
		} finally {
			uFile.getFile().delete();
		}
	}
	
	public static int getPendingCount(String deviceId) {
		int count = Db.find("select * from repair_application where device_id = ? and status = ?", deviceId, RepairApplication.PENDING_STATUS).size();
		return count;
	}
}
